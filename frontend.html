<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hair Counter (HTML + JS + C/C++)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px}
    .container{max-width:900px;margin:0 auto}
    img{max-width:100%;height:auto;border:1px solid #ddd;padding:6px;border-radius:8px}
    #preview{margin-top:12px}
    button{padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer}
    pre{background:#f6f8fa;padding:12px;border-radius:8px;overflow:auto}
  </style>
</head>
<body>
  <div class="container">
    <h1>Hair Counter (Demo)</h1>
    <p>Choose a clear, high-resolution close-up of the scalp for best results.</p>

    <input id="file" type="file" accept="image/*" />
    <button id="send">Count Hairs</button>

    <div id="preview">
      <h3>Selected image</h3>
      <img id="imgPreview" src="" alt="No image selected" />
    </div>

    <div id="result" style="margin-top:18px;display:none">
      <h3>Result</h3>
      <p><strong>Estimated hair count:</strong> <span id="count">â€”</span></p>
      <h4>Annotated image</h4>
      <img id="annotated" src="" alt="Annotated output" />
      <h4>Server response</h4>
      <pre id="raw"></pre>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('file')
    const imgPreview = document.getElementById('imgPreview')
    const sendBtn = document.getElementById('send')
    const resultDiv = document.getElementById('result')
    const countSpan = document.getElementById('count')
    const annotatedImg = document.getElementById('annotated')
    const rawPre = document.getElementById('raw')

    let fileBlob = null

    fileInput.addEventListener('change', e => {
      const f = e.target.files[0]
      if (!f) return
      fileBlob = f
      imgPreview.src = URL.createObjectURL(f)
      resultDiv.style.display = 'none'
    })

    sendBtn.addEventListener('click', async () => {
      if (!fileBlob) {
        alert('Please choose an image first')
        return
      }
      sendBtn.disabled = true
      sendBtn.textContent = 'Processing...'

      const fd = new FormData()
      fd.append('image', fileBlob)

      try {
        // change path if your CGI endpoint is different
        const resp = await fetch('/cgi-bin/hair_counter.cgi', { method: 'POST', body: fd })
        const text = await resp.text()
        // CGI should return JSON
        let data
        try { data = JSON.parse(text) } catch (e) {
          throw new Error('Invalid JSON from server: ' + text)
        }
        if (!resp.ok) throw new Error(data.error || 'Server error')

        countSpan.textContent = data.count
        annotatedImg.src = 'data:image/png;base64,' + data.annotated_image
        rawPre.textContent = JSON.stringify(data, null, 2)
        resultDiv.style.display = 'block'
      } catch (err) {
        alert('Error: ' + err.message)
      } finally {
        sendBtn.disabled = false
        sendBtn.textContent = 'Count Hairs'
      }
    })
  </script>
</body>
</html>

